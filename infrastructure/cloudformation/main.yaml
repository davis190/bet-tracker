AWSTemplateFormatVersion: '2010-09-09'
Description: 'Main infrastructure stack for Bet Tracker App - Cognito, DynamoDB, API Gateway'

Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues: [dev, staging, prod]
    Description: Environment name
  
  ProjectName:
    Type: String
    Default: bet-tracker
    Description: Project name for resource naming

Resources:
  # Cognito User Pool
  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub '${ProjectName}-${Environment}-user-pool'
      AutoVerifiedAttributes:
        - email
      UsernameAttributes:
        - email
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireUppercase: true
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: true
      Schema:
        - Name: email
          Required: true
          Mutable: true

  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: !Sub '${ProjectName}-${Environment}-client'
      UserPoolId: !Ref UserPool
      GenerateSecret: false
      ExplicitAuthFlows:
        - ALLOW_USER_SRP_AUTH
        - ALLOW_USER_PASSWORD_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
      PreventUserExistenceErrors: ENABLED

  # DynamoDB Tables
  UsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-${Environment}-users'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
      KeySchema:
        - AttributeName: userId
          KeyType: HASH

  BetsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub '${ProjectName}-${Environment}-bets'
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: StatusIndex
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  # API Gateway
  ApiGatewayRestApi:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: !Sub '${ProjectName}-${Environment}-api'
      Description: Bet Tracker API
      EndpointConfiguration:
        Types:
          - REGIONAL

  # API Gateway Custom Domain
  ApiGatewayDomainName:
    Type: AWS::ApiGateway::DomainName
    Properties:
      DomainName: bets-api.claytondavis.dev
      RegionalCertificateArn: arn:aws:acm:us-east-1:690641653089:certificate/353de965-0214-4570-a541-0b944ce658a6
      EndpointConfiguration:
        Types:
          - REGIONAL
      SecurityPolicy: TLS_1_2

  # API Gateway Base Path Mapping
  ApiGatewayBasePathMapping:
    Type: AWS::ApiGateway::BasePathMapping
    Properties:
      DomainName: !Ref ApiGatewayDomainName
      RestApiId: !Ref ApiGatewayRestApi
      Stage: !Ref Environment

  # Cognito Authorizer
  CognitoAuthorizer:
    Type: AWS::ApiGateway::Authorizer
    Properties:
      Name: CognitoAuthorizer
      RestApiId: !Ref ApiGatewayRestApi
      Type: COGNITO_USER_POOLS
      ProviderARNs:
        - !GetAtt UserPool.Arn
      IdentitySource: method.request.header.Authorization

  # S3 Bucket for SAM artifacts
  SamArtifactsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-${Environment}-sam-artifacts-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldArtifacts
            Status: Enabled
            ExpirationInDays: 30

Outputs:
  UserPoolId:
    Description: Cognito User Pool ID
    Value: !Ref UserPool
    Export:
      Name: !Sub '${ProjectName}-${Environment}-user-pool-id'

  UserPoolClientId:
    Description: Cognito User Pool Client ID
    Value: !Ref UserPoolClient
    Export:
      Name: !Sub '${ProjectName}-${Environment}-user-pool-client-id'

  ApiGatewayId:
    Description: API Gateway Rest API ID
    Value: !Ref ApiGatewayRestApi
    Export:
      Name: !Sub '${ProjectName}-${Environment}-api-id'

  ApiGatewayRootResourceId:
    Description: API Gateway Root Resource ID
    Value: !GetAtt ApiGatewayRestApi.RootResourceId
    Export:
      Name: !Sub '${ProjectName}-${Environment}-api-root-id'

  BetsTableName:
    Description: DynamoDB Bets Table Name
    Value: !Ref BetsTable
    Export:
      Name: !Sub '${ProjectName}-${Environment}-bets-table-name'

  UsersTableName:
    Description: DynamoDB Users Table Name
    Value: !Ref UsersTable
    Export:
      Name: !Sub '${ProjectName}-${Environment}-users-table-name'

  CognitoAuthorizerId:
    Description: Cognito Authorizer ID
    Value: !Ref CognitoAuthorizer
    Export:
      Name: !Sub '${ProjectName}-${Environment}-authorizer-id'

  SamArtifactsBucketName:
    Description: S3 Bucket Name for SAM Artifacts
    Value: !Ref SamArtifactsBucket
    Export:
      Name: !Sub '${ProjectName}-${Environment}-sam-artifacts-bucket'

  ApiGatewayDomainName:
    Description: API Gateway Custom Domain Name
    Value: !Ref ApiGatewayDomainName
    Export:
      Name: !Sub '${ProjectName}-${Environment}-api-domain-name'

  ApiGatewayDomainNameValue:
    Description: API Gateway Custom Domain Name Value
    Value: bets-api.claytondavis.dev
    Export:
      Name: !Sub '${ProjectName}-${Environment}-api-domain-value'

  ApiGatewayRegionalDomainName:
    Description: API Gateway Regional Domain Name (for DNS CNAME)
    Value: !GetAtt ApiGatewayDomainName.RegionalDomainName
    Export:
      Name: !Sub '${ProjectName}-${Environment}-api-regional-domain'

